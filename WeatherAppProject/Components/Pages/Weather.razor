@page "/WeatherData"
@using Microsoft.JSInterop;
@using WeatherAppProject.Services
@using WeatherAppProject.Model
@rendermode InteractiveServer
@inject WeatherService weatherservice

<PageTitle>Weather Forecast</PageTitle>

<h1 class="text-center">Weather Forecast</h1>

@if (currentWeather != null)
{
    <!-- Top Current Weather Layout -->
   <div class="card mx-auto mb-4 p-4" style="width: 50%; text-align: center; background-color:#222; color:#fff; border-radius:15px;">
       <h2 class="mb-3" style="font-size:2rem; font-weight:bold;">@currentWeather.Name</h2>
       
       <!-- Large Temperature and Icon -->
       <div class="d-flex justify-content-center align-items-center">
            <span style="font-size:4rem; font-weight:bold;">@(Math.Round(currentWeather.Main.Temp))°</span>
            @if(currentWeather.Weather.Length > 0)
            {
                var iconUrl = $"https://openweathermap.org/img/wn/{currentWeather.Weather[0].Icon}@4x.png";
                <img src="@iconUrl" alt="Weather Icon" style="width:100px; height:100px; margin-left:10px"/>
            }
        </div>

        <!-- Weather Description -->
        <p class="mb-0" style="font-size:1.25rem; font-weight:500;">@currentWeather.Weather[0].Description</p>

        <!-- High and Low Temperature -->
            @if(dailyForecasts.Count > 0)
            {
                var todayForecast = dailyForecasts.First();
                <p class="mt-2" style="font-size: 1rem;">
                    Highest @todayForecast.TempMax° · Lowest @todayForecast.TempMin
                </p>

            }
   </div>
    <!-- Hourly Forecast -->
    <div class="card mx-auto mb-4 p-3" style="width: 70%; background-color: #222; color: #fff;">
        <h5 class="text-center mb-3">Prognos per 3 timmar</h5>
        <div class="d-flex justify-content-around overflow-auto" style="font-size:larger">
            @foreach (var item in hourlyForecasts)
            {
                var iconUrl = $"https://openweathermap.org/img/wn/{item.Icon}@2x.png";
                <div class="text-center" style="min-width: 60px;">
                    <p class="mb-1">@item.Time</p>
                    <img src="@iconUrl" alt="Weather Icon" style="width: 80px; height: 80px;" />
                    <p class="mb-0">@item.Temp°C</p>
                </div>
            }
        </div>
    </div>

    <!-- Daily Forecast -->
    <div class="card mx-auto p-3" style="width: 70%; background-color: #222; color: #fff;">
        <h5 class="text-center mb-3">5-dagarsprognos</h5>
        <div class="d-flex justify-content-around flex-wrap" style="font-size:larger">
            @foreach (var dailyForecast in dailyForecasts)
            {
                var iconUrl = $"https://openweathermap.org/img/wn/{dailyForecast.Icon}@2x.png";
                <div class="text-center mx-2 mb-2" style="min-width: 80px;">
                    <p class="mb-1">@dailyForecast.DayName</p>
                    <img src="@iconUrl" alt="Weather Icon" style="width: 100px; height: 100px;" />
                    <p class="mb-0">@dailyForecast.TempMax°C / @dailyForecast.TempMin°C</p>
                    <p class="mb-0">@dailyForecast.ChanceOfRain%</p>
                </div>
            }
        </div>
    </div>
}
else
{
    <p class="text-center">Loading weather data...</p>
}

@code {
    private CurrentWeather currentWeather;
    private List<HourlyForecast> hourlyForecasts = new();
    private List<DailyForecast> dailyForecasts = new();

    protected override async Task OnInitializedAsync()
    {
        await FetchWeatherData("Gothenburg");
    }

    private async Task FetchWeatherData(string city)
    {
        try
        {
            currentWeather = await weatherservice.GetWeatherAsync(city);
            var forecast = await weatherservice.GetWeatherForecastAsync(city);

            // Map hourly forecast
            hourlyForecasts = forecast.List.Take(8).Select(item => new HourlyForecast
                {
                    Time = DateTime.Parse(item.Dt_txt).ToShortTimeString(),
                    Temp = (int)Math.Round(item.main.Temp),
                    Icon = item.weather[0].Icon
                }).ToList();

            // Map daily forecast (group by day)
            dailyForecasts = forecast.List
                .GroupBy(item => DateTime.Parse(item.Dt_txt).Date)
                .Select(group => new DailyForecast
                    {
                        DayName = group.Key.DayOfWeek.ToString(),
                        TempMax = (int)Math.Round(group.Max(x => x.main.Temp)),
                        TempMin = (int)Math.Round(group.Min(x => x.main.Temp)),
                        ChanceOfRain = group.First().Pop * 100, // Probability of precipitation
                        Icon = group.First().weather[0].Icon
                    })
                .Take(5) // Next 5 days
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching weather data: {ex.Message}");
        }
    }
}